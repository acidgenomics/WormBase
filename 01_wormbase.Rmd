---
title: "WormBase annotations"
date: "`r BiocStyle::doc_date()`"
author: "Michael J. Steinbaugh"
---

```{r setup, include=FALSE}
source("setup.R")
```

# Gene

```{r geneIDs}
geneIDs <- wormbaseAnnotationFile("geneIDs") %>%
    read_csv(col_names = c("X", "gene", "name", "sequence", "status"),
             na = "") %>%
    select(-X)
```

```{r geneOtherIDs}
geneOtherIDs <- wormbaseAnnotationFile("geneOtherIDs") %>%
    read_file %>%
    # Strip out live/dead status, already have in gene
    str_replace_all("\t(Dead|Live)", "") %>%
    # Take the tabs out for gene list
    str_replace_all("\t", ", ") %>%
    # Add tab back in to separate \code{gene} for row names
    str_replace_all("WBGene(\\d+), ", "WBGene\\1\t") %>%
    # Warnings here mean there are no other IDs for that row
    # (e.g. expected: 2 columns, actual: 1 columns)
    read_tsv(col_names = c("gene", "otherIdentifier"))
```



# Description

```{r description}
file <- wormbaseAnnotationFile("functional_descriptions")
names <- read_lines(file, n_max = 1, skip = 3) %>%
    str_split(" ") %>%
    .[[1]] %>%
    str_replace_all("(\\w+)_description$", "description_\\1") %>%
    camel %>%
    str_replace("descriptionGeneClass", "class") %>%
    str_replace("geneId", "gene") %>%
    str_replace("molecularName", "sequence") %>%
    str_replace("publicName", "name")
description <- read_delim(file, delim = "\t",
               col_names = names,
               skip = 4,
               na = c("", "none available", "not known")) %>%
    select(-c(name, sequence)) %>%
    filter(grepl("^WBGene\\d+$", gene))
rm(file, names)
```



# Ortholog

```{r ortholog}
raw_df <- wormbaseAnnotationFile("orthologs") %>%
    read_file %>%
    str_replace_all("\t", " | ") %>%
    str_replace_all("\n", " // ") %>%
    gsub("= // ", "\n", .) %>%
    gsub(" //  // ", "\t", .) %>%
    read_tsv(comment = "#", col_names = c("gene", "ortholog")) %>%
    mutate(gene = gsub("^(WBGene\\d{8}).*", "\\1", gene))
list <- mclapply(1:nrow(raw_df), function(a) {
    # Human
    hsapiens <- str_extract_all(
        raw_df[a, 2],
        pattern = "\\bENSG\\d{11}\\b") %>% unlist
    # Mouse
    mmusculus <- str_extract_all(
        raw_df[a, 2],
        pattern = "\\bENSMUSG\\d{11}\\b") %>% unlist
    # Fruit fly
    dmelanogaster <- str_extract_all(
        raw_df[a, 2],
        pattern = "\\bFBgn\\d{7}\\b") %>% unlist
    # Zebrafish
    drerio <- str_extract_all(
        raw_df[a, 2],
        pattern = "\\bENSDARG\\d{11}\\b") %>% unlist
    return(list(
        hsapiens = hsapiens,
        mmusculus = mmusculus,
        dmelanogaster = dmelanogaster,
        drerio = drerio
    ))
}) %>% setNames(raw_df$gene)
ortholog <- tibble(gene = names(list), ortholog = list)
rm(list, raw_df)
```



# RNAi phenotype

```{r rnaiPhenotype}
fileLocal <- file.path("data-raw",
                       "wormbase",
                       "rnai_phenotypes.tsv.gz")
if (!file.exists(fileLocal)) {
    # Improve this code using the `transmit()` function
    dir <- file.path("ftp://ftp.wormbase.org",
                     "pub",
                     "wormbase",
                     "releases",
                     "current-production-release",
                     "ONTOLOGY")
    fileRemote <- getURL(paste0(dir, "/"), dirlistonly = TRUE) %>%
        str_split("\n") %>%
        .[[1]] %>%
        str_subset("rnai_phenotypes_quick") %>%
        file.path(dir, .)
    fileLocal <- file.path("data-raw",
                           "wormbase",
                           "rnai_phenotypes.tsv")
    download.file(fileRemote, fileLocal)
    fileLocal <- gzip(fileLocal, overwrite = TRUE)
    rm(dir, fileRemote)
}
rnaiPhenotype <- read_tsv(
    fileLocal,
    col_names = c("gene",
                  "sequence",
                  "rnaiPhenotype")) %>%
    select(-sequence)
rm(fileLocal)
```



# BLASTP

```{r wormpep}
fileLocal <- file.path("data-raw",
                       "wormbase",
                       "wormpep.tsv.gz")
if (!file.exists(fileLocal)) {
    dir <- file.path("ftp://ftp.wormbase.org",
                     "pub",
                     "wormbase",
                     "releases",
                     "current-production-release",
                     "species",
                     "c_elegans",
                     "PRJNA13758")
    fileRemote <- getURL(paste0(dir, "/"),
                         dirlistonly = TRUE) %>%
        str_split("\n") %>%
        .[[1]] %>%
        str_subset("wormpep_package") %>%
        as.character %>%
        file.path(dir, .)
    download.file(fileRemote, fileLocal)
    untar(fileLocal,
          exdir = file.path("data-raw", "wormbase"),
          files = "wormpep.table*")
    # Safe to delete the large source file
    unlink(fileLocal)
    fileLocal <- list.files(
        path = file.path("data-raw", "wormbase"),
        pattern = "wormpep.table",
        full.names = TRUE)
    fileRename <- file.path("data-raw",
                            "wormbase",
                            "wormpep.tsv")
    file.rename(fileLocal, fileRename)
    fileLocal <- fileRename
    fileLocal <- gzip(fileLocal, overwrite = TRUE)
    rm(fileRename)
}
wormpep <- read_lines(fileLocal) %>%
    str_split("\n") %>%
    mclapply(function(x) {
        gsub("^.*\t(CE[0-9]+\tWBGene[0-9]+).*$", "\\1", x) %>%
            str_split("\t") %>% .[[1]]
    }) %>%
    do.call(rbind, .) %>%
    as_tibble %>%
    setNames(c("wormpep", "gene"))
```

```{r bestBlastHits}
bestBlastHits <- wormbaseAnnotationFile("best_blast_hits") %>%
    read_csv(col_names = FALSE) %>%
    select(X1, X4, X5) %>%
    rename(wormpep = X1,
           peptide = X4,
           eValue = X5) %>%
    filter(grepl("^ENSEMBL", peptide)) %>%
    mutate(peptide = str_sub(peptide, 9))
```

```{r blastp}
blastp <- left_join(
    wormpep, bestBlastHits, by = "wormpep") %>%
    group_by(gene) %>%
    nest(.key = blastp)
rm(bestBlastHits, fileLocal, wormpep)
```



# Oligo

```{r oligo}
oligo <- wormbaseAnnotationFile("pcr_product2gene") %>%
    read_tsv(col_names = c("oligo", "gene")) %>%
    mutate(gene = str_extract(gene, "WBGene\\d{8}")) %>%
    group_by(gene) %>%
    nest(.key = oligo)
```



# WormBase list

```{r wormbase}
list <- list(
    geneIDs = geneIDs,
    geneOtherIDs = geneOtherIDs,
    description = description,
    blastp = blastp,
    ortholog = ortholog,
    rnaiPhenotype = rnaiPhenotype,
    oligo = oligo)
summary(list)
lapply(list, glimpse) %>% invisible
print(object.size(list), units = "auto")

# wormbase <- Reduce(function(...) merge(..., by = "gene", all.x = TRUE), list)
wormbase <- Reduce(function(...) full_join(..., by = "gene"), list)
glimpse(wormbase)
print(object.size(wormbase), units = "auto")
rm(list)

save(wormbase, file = file.path("data-raw", "wormbase.rda"))
```
